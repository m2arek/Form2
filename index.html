<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FRH PRO formulaire  - vbetools4</title>

  <!-- (1) Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- (2) Leaflet Draw + GeometryUtil CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <!-- Liens CSS pour Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- (3) Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- (4) Leaflet Draw JS -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- (5) GeometryUtil (pour la surface) -->
  <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>
  <!-- (6) html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Script de localisation français pour Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  
  <!-- Chart.js pour le diagramme en barres -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /****************************************************
     * STYLES GÉNÉRAUX
     ****************************************************/
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    .page-title {
      text-align: center;
      margin-bottom: 30px;
    }

    /****************************************************
     * ONGLET NAVIGATION
     ****************************************************/
    .tabNav {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 2px solid #ccc;
    }
    .tabNav button {
      background: #c0ddff;
      border: none;
      outline: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease, color 0.3s ease;
      border-right: 1px solid #ccc;
    }
    .tabNav button:last-child {
      border-right: none;
    }
    .tabNav button:hover {
      background-color: #a8d8ff;
    }
    .tabNav button.activeTab {
      background-color: #3498db;
      color: #fff;
    }

    /****************************************************
     * CONTENU D'ONGLET
     ****************************************************/
    .tabContent {
      display: none;
      padding: 20px 0;
    }
    .tabContent.activeTab {
      display: block;
    }

    /****************************************************
     * LOGO
     ****************************************************/
    .tabLogo {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .tabLogo img {
      max-height: 50px;
      margin-right: 15px;
    }
    .tabLogo h2 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    /****************************************************
     * FORMULAIRES ET BLOCS
     ****************************************************/
    form {
      display: block;
      margin-bottom: 20px;
    }
    .form-section {
      background-color: #fafafa;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .form-section h3 {
      background-color: #e0efff;
      padding: 8px 12px;
      border-radius: 4px;
      color: #333;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .form-section label {
      font-weight: 500;
      margin-top: 5px;
      display: block;
    }
    .form-section input[type="text"],
    .form-section input[type="number"],
    .form-section input[type="time"],
    .form-section input[type="email"],
    .form-section textarea,
    .form-section select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .form-section input[disabled] {
      background-color: #ececec;
      color: #666;
    }

    /****************************************************
     * TABLES
     ****************************************************/
    table {
      border: 1px solid #ddd;
      border-collapse: collapse;
      width: 100%;
      text-align: center;
    }
    table th, table td {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
    }
    table thead {
      background-color: #f0f0f0;
    }

    /****************************************************
     * CARTE, BOUTONS
     ****************************************************/
    #map-container {
      position: relative;
      width: 100%;
      height: 500px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #drawingCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1000;
      pointer-events: none;
    }
    button {
      display: inline-block;
      padding: 10px 15px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #3498db;
      color: #fff;
      cursor: pointer;
      margin-right: 5px;
      margin-bottom: 5px;
      transition: background-color 0.3s ease, transform 0.2s;
    }
    button:hover {
      background-color: #2980b9;
      transform: scale(1.03);
    }

    /****************************************************
     * CHECKBOX GRID
     ****************************************************/
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 5px 10px;
      margin-top: 5px;
    }

    /****************************************************
     * GRAPHIQUE
     ****************************************************/
    #monthlyBarChart {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="page-title">Formulaire FRH PRO </h1>

    <div class="tabNav" id="topTabNav">
      <button type="button" class="tablinks" onclick="openTab(event, 'tab1')">1. Localisation / Données Irradiation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab4')">4. Infos société</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab5')">5. Infos toiture</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab6')">6. Périodes d'utilisation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab7')">7. Conso mensuelle</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab10')">10. Commentaires</button>
    </div>

    <!-- Formulaire global -->
    <form id="userForm">
      <!-- TAB 1 : Localisation & Données Irradiation -->
      <div id="tab1" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Localisation & Données Irradiation</h2>
        </div>

        <label for="address">Adresse :</label>
        <input type="text" id="address" name="address" placeholder="Entrez une adresse" required />
        <button type="button" id="addressSearchBtn">Rechercher</button>

        <button type="button" id="toggleDrawingButton">Activer le dessin (main levée)</button>
        <button type="button" id="toggleMeasureButton">Mesurer une surface</button>

        <div id="map-container">
          <div id="map"></div>
          <canvas id="drawingCanvas"></canvas>
        </div>

        <div class="form-section">
          <h3>Données irradiation</h3>

          <label for="latitudeIrr">Latitude :</label>
          <input type="text" id="latitudeIrr" name="latitudeIrr" readonly />

          <label for="longitudeIrr">Longitude :</label>
          <input type="text" id="longitudeIrr" name="longitudeIrr" readonly />

          <label for="orientationIrr">Orientation :</label>
          <select id="orientationIrr" name="orientationIrr">
            <option value="0">SUD (0°)</option>
            <option value="-90">EST (-90°)</option>
            <option value="90">OUEST (90°)</option>
            <option value="-45">SUD-EST (-45°)</option>
            <option value="45">SUD-OUEST (45°)</option>
          </select>

          <label for="orientation">Orientation (vrai angle °) :</label>
          <input type="text" id="orientation" name="orientation" readonly />

          <label for="angleIrr">Angle (°) :</label>
          <input type="number" id="angleIrr" name="angleIrr" value="35" />

          <label for="productible">Productible :</label>
          <input type="text" id="productible" name="productible" placeholder="kWh/kWc/an" readonly/>

          <!-- Nouveau champ Territoire (détecté auto) -->
          <label for="territory">Territoire détecté :</label>
          <input type="text" id="territory" name="territory" disabled />

          <button type="button" id="calculateIrrButton">Calculer le productible</button>
        </div>
      </div><!-- fin tab1 -->

      <!-- TAB 4 : Infos société -->
      <div id="tab4" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Informations sur la société</h2>
        </div>
        <div class="form-section">
          <h3>Informations sur la société</h3>
          <label for="Adresse">Adresse entrée :</label>
          <input type="text" id="Adresse" name="Adresse" readonly />

          <label for="companyName">Société :</label>
          <input type="text" id="companyName" name="companyName"/>

          <label for="activity">Activité :</label>
          <input type="text" id="activity" name="activity"/>

          <label for="Nom">Nom :</label>
          <input type="text" id="Nom" name="Nom"/>

          <label for="Prénom">Prénom :</label>
          <input type="text" id="Prénom" name="Prénom"/>
          
          <!-- Nouveaux champs ajoutés -->
          <label for="telephone">Téléphone :</label>
          <input type="text" id="telephone" name="telephone" pattern="\d{10}" title="Le numéro de téléphone doit comporter 10 chiffres" placeholder="Ex : 0123456789" />

          <label for="email">Email :</label>
          <input type="email" id="email" name="email" placeholder="exemple@domaine.com" />
          
          <label for="Propietaire/Locataire">Propietaire/Locataire :</label>
          <select id="Propietaire/Locataire" name="Propietaire/Locataire">
            <option value="" disabled selected>indiquer si propietaire ou locataire</option>
            <option value="Proprietaire">Proprietaire</option>
            <option value="Locataire">Locataire</option>
          </select>

          <label for="Annees presence">Annees presence :</label>
          <input type="text" id="Annees presence" name="Annees presence" placeholder="Entrez le nombre d'Annees de presence" />
        </div>
      </div><!-- fin tab4 -->

      <!-- TAB 5 : Infos toiture -->
      <div id="tab5" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Informations sur la toiture</h2>
        </div>
        <div class="form-section">
          <h3>Informations sur la toiture</h3>

          <label for="Surface toiture">Surface toiture (m²) :</label>
          <!-- La valeur de ce champ sera mise à jour depuis l'onglet 1 -->
          <input type="number" id="Surface toiture" name="Surface toiture" />

          <label for="Partage sa toiture">Partage sa toiture? :</label>
          <select id="Partage sa toiture" name="Partage sa toiture">
            <option value="" disabled selected>indiquer si la toiture est partagee</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>

          <label for="Type de toiture">Type de toiture :</label>
          <select id="Type de toiture" name="Type de toiture">
            <option value="" disabled selected>Choisissez un Type de toiture</option>
            <option value="2 pentes">2 pentes</option>
            <option value="1 pente">1 pente</option>
            <option value="Toit plat">Toit plat</option>
          </select>

          <label for="Pente toiture">Pente toiture (°) :</label>
          <input type="number" id="Pente toiture" name="Pente toiture" />

          <label for="Type de couverture">Type de couverture :</label>
          <select id="Type de couverture" name="Type de couverture">
            <option value="" disabled selected>Choisissez un type de couverture</option>
            <option value="Bacs acier">Bacs acier</option>
            <option value="Fibro ciment">Fibro ciment</option>
            <option value="Tuiles">Tuiles</option>
            <option value="Beton">Beton</option>
          </select>

          <label for="Type de charpente">Type de charpente :</label>
          <select id="Type de charpente" name="Type de charpente">
            <option value="" disabled selected>Choisissez un type de charpente</option>
            <option value="Metallique">Métallique</option>
            <option value="Bois">Bois</option>
          </select>

          <label for="Translucides">Présence de translucides :</label>
          <select id="Translucides" name="Translucides">
            <option value="" disabled selected>Presence de translucides</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>

          <label for="Couvrir Translucides">Couvrir Translucides :</label>
          <select id="Couvrir Translucides" name="Couvrir Translucides">
            <option value="" disabled selected>Couvrir Translucides</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>
        </div>
      </div><!-- fin tab5 -->

      <!-- TAB 6 : Périodes d'utilisation -->
      <div id="tab6" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Périodes d'utilisation</h2>
        </div>
        <div class="form-section">
          <h3>Périodes d'utilisation</h3>
          <h4>Mois de congés</h4>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="moisConges[]" value="Janvier" />Janvier</label>
            <label><input type="checkbox" name="moisConges[]" value="Février" />Février</label>
            <label><input type="checkbox" name="moisConges[]" value="Mars" />Mars</label>
            <label><input type="checkbox" name="moisConges[]" value="Avril" />Avril</label>
            <label><input type="checkbox" name="moisConges[]" value="Mai" />Mai</label>
            <label><input type="checkbox" name="moisConges[]" value="Juin" />Juin</label>
            <label><input type="checkbox" name="moisConges[]" value="Juillet" />Juillet</label>
            <label><input type="checkbox" name="moisConges[]" value="Août" />Août</label>
            <label><input type="checkbox" name="moisConges[]" value="Septembre" />Septembre</label>
            <label><input type="checkbox" name="moisConges[]" value="Octobre" />Octobre</label>
            <label><input type="checkbox" name="moisConges[]" value="Novembre" />Novembre</label>
            <label><input type="checkbox" name="moisConges[]" value="Décembre" />Décembre</label>
          </div>

          <h4>Jours de congés</h4>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="joursConges[]" value="Lundi" />Lundi</label>
            <label><input type="checkbox" name="joursConges[]" value="Mardi" />Mardi</label>
            <label><input type="checkbox" name="joursConges[]" value="Mercredi" />Mercredi</label>
            <label><input type="checkbox" name="joursConges[]" value="Jeudi" />Jeudi</label>
            <label><input type="checkbox" name="joursConges[]" value="Vendredi" />Vendredi</label>
            <label><input type="checkbox" name="joursConges[]" value="Samedi" />Samedi</label>
            <label><input type="checkbox" name="joursConges[]" value="Dimanche" />Dimanche</label>
          </div>

          <label for="heureDebut">Heure début travail :</label>
          <input type="time" id="heureDebut" name="heureDebut" />

          <label for="heureFin">Heure fin :</label>
          <input type="time" id="heureFin" name="heureFin" />

          <label for="Puissance compteur">Puissance compteur (Kva) :</label>
          <input type="number" id="Puissance compteur" name="Puissance compteur" />
        </div>
      </div><!-- fin tab6 -->

      <!-- TAB 7 : Conso mensuelle -->
      <div id="tab7" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Consommation mensuelle</h2>
        </div>
        <div id="consumptionTableContainer" class="form-section">
          <h3>Consommation mensuelle</h3>
          <table id="consumptionTable">
            <thead>
              <tr>
                <th style="width: 20%;">Mois</th>
                <th style="width: 25%;">Consommation (€)</th>
                <th style="width: 25%;">Consommation (kWh)</th>
                <th style="width: 30%;">Coût par kWh (€)</th>
              </tr>
            </thead>
            <tbody id="consumptionTableBody">
              <!-- Les lignes seront insérées dynamiquement -->
              <!-- Ligne Totaux annuels en bas -->
              <tr>
                <td><strong>Total annuel</strong></td>
                <td id="totalEuros">-</td>
                <td id="totalKwh">-</td>
                <td id="totalCostPerKwh">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div><!-- fin tab7 -->

      <!-- TAB 10 : Commentaires -->
      <div id="tab10" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Commentaires</h2>
        </div>
        <!-- Nouveau champ Opérateur ajouté au-dessus du bloc RDV -->
        <div class="form-section">
          <h3>Opérateur</h3>
          <label for="operateur">Opérateur :</label>
          <input type="text" id="operateur" name="operateur" placeholder="Nom de l'opérateur" />
        </div>
        <div class="form-section">
          <h3>RDV</h3>
          <label for="rdvDate">Date du RDV :</label>
          <input type="text" id="rdvDate" name="rdvDate" placeholder="Choisissez une date" />
  
          <label for="rdvTime">Heure du RDV :</label>
          <input type="time" id="rdvTime" name="rdvTime" />
        </div>
        <div class="form-section">
          <h3>Commentaires</h3>
          <label for="comments">Commentaires :</label>
          <textarea id="comments" name="comments" placeholder="Entrez vos commentaires"></textarea>
        </div>
        <!-- Boutons pour la gestion JSON (export et import) + nouveau bouton POST -->
        <div style="margin-bottom:15px;">
          <button type="button" id="saveToFile">Sauvegarder les données</button>
          <input type="file" id="loadFromFile" style="display: none;" />
          <button type="button" id="uploadFile">Charger un fichier</button>
          <button type="button" id="postData">POST</button>
        </div>
      </div><!-- fin tab10 -->
    </form><!-- fin userForm -->
  </div><!-- fin container -->

  <script>
    /******************************************************
     * GESTION DES ONGLETS + AJUSTEMENT CARTE
     ******************************************************/
    function openTab(evt, tabId) {
      const tabContents = document.getElementsByClassName("tabContent");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("activeTab");
      }
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("activeTab");
      }
      document.getElementById(tabId).classList.add("activeTab");
      evt.currentTarget.classList.add("activeTab");

      if (tabId === 'tab1') {
        setTimeout(() => {
          map.invalidateSize();
        }, 300);
      }
    }

    /***************************************************
     * INITIALISATION DES VARIABLES ET DE LA CARTE
     ***************************************************/
    // Variable pour stocker d'éventuelles données de production (non affichées)
    let monthlyProductionData = [];

    // Initialisation dynamique du tableau de consommation mensuelle (onglet 7)
    window.addEventListener("load", function() {
      const consumptionTableBody = document.getElementById("consumptionTableBody");
      const months = [
        "Janvier","Février","Mars","Avril","Mai","Juin",
        "Juillet","Août","Septembre","Octobre","Novembre","Décembre"
      ];
      const lastRow = consumptionTableBody.querySelector("tr");
      months.forEach((month, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${month}</td>
          <td>
            <input type="number" id="euros_${index}" name="euros_${index}" placeholder="€" style="width: 90%;" oninput="calculateCost(${index})" />
          </td>
          <td>
            <input type="number" id="kwh_${index}" name="kwh_${index}" placeholder="kWh" style="width: 90%;" oninput="calculateCost(${index})" />
          </td>
          <td id="costPerKwh_${index}">-</td>
        `;
        consumptionTableBody.insertBefore(row, lastRow);
      });
      // Ouvre le premier onglet par défaut
      const firstTabButton = document.querySelector(".tabNav button");
      if (firstTabButton) {
        firstTabButton.click();
      }
    });

    /***************************************************
     * INITIALISATION DE LA CARTE ET DES OUTILS DE DESSIN
     ***************************************************/
    const map = L.map("map").setView([48.8566, 2.3522], 18);
    const tileLayer = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
      maxZoom: 20,
      subdomains: ["mt0", "mt1", "mt2", "mt3"],
      attribution: "© Google",
    });
    tileLayer.addTo(map);

    let searchMarker = null;

    // Dessin libre sur Canvas
    const drawingCanvas = document.getElementById("drawingCanvas");
    const ctx = drawingCanvas.getContext("2d");
    const AdresseField = document.getElementById("Adresse");

    let drawing = false;
    let drawingEnabled = false;

    const toggleDrawingButton = document.getElementById("toggleDrawingButton");
    toggleDrawingButton.addEventListener("click", () => {
      drawingEnabled = !drawingEnabled;
      drawingCanvas.style.pointerEvents = drawingEnabled ? "auto" : "none";
      toggleDrawingButton.textContent = drawingEnabled
        ? "Désactiver le dessin"
        : "Activer le dessin (main levée)";
    });

    function resizeCanvas() {
      drawingCanvas.width = drawingCanvas.offsetWidth;
      drawingCanvas.height = drawingCanvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    drawingCanvas.addEventListener("mousedown", (event) => {
      if (!drawingEnabled) return;
      drawing = true;
      ctx.beginPath();
      const rect = drawingCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      ctx.moveTo(x, y);
    });
    drawingCanvas.addEventListener("mouseup", () => {
      if (!drawingEnabled) return;
      drawing = false;
      ctx.beginPath();
    });
    drawingCanvas.addEventListener("mousemove", (event) => {
      if (!drawing || !drawingEnabled) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "red";
      const rect = drawingCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      ctx.lineTo(x, y);
      ctx.stroke();
    });

    // Outils Leaflet Draw
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        marker: false,
        circle: false,
        circlemarker: false,
        polygon: true,
        rectangle: true,
        polyline: true
      },
      edit: {
        featureGroup: drawnItems
      }
    });

    let measureActive = false;
    const measureButton = document.getElementById("toggleMeasureButton");
    measureButton.addEventListener("click", () => {
      measureActive = !measureActive;
      if (measureActive) {
        map.addControl(drawControl);
        measureButton.textContent = "Terminer la mesure";
      } else {
        map.removeControl(drawControl);
        measureButton.textContent = "Mesurer une surface";
      }
    });

    function computeBearing(lat1, lng1, lat2, lng2) {
      const toRad = (val) => val * Math.PI / 180;
      const toDeg = (val) => val * 180 / Math.PI;
      const dLon = toRad(lng2 - lng1);
      const y = Math.sin(dLon) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
      let brng = Math.atan2(y, x);
      brng = toDeg(brng);
      return (brng + 360) % 360;
    }

    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);

      if (e.layerType === "polygon" || e.layerType === "rectangle") {
        let latLngs = layer.getLatLngs();
        if (Array.isArray(latLngs[0])) {
          latLngs = latLngs[0];
        }
        const area = L.GeometryUtil.geodesicArea(latLngs);
        const areaInt = Math.round(area);
        alert(`Surface mesurée : ${areaInt.toLocaleString('fr-FR')} m²`);
        // Mise à jour du champ "Surface toiture" (onglet 5)
        document.getElementById("Surface toiture").value = areaInt;
      } else if (e.layerType === "polyline") {
        const latLngs = layer.getLatLngs();
        if (latLngs.length < 2) {
          alert("Tracez au moins 2 points pour la ligne d'orientation.");
          return;
        }
        const first = latLngs[0];
        const last = latLngs[latLngs.length - 1];
        const angle = computeBearing(first.lat, first.lng, last.lat, last.lng);
        let aspectVal = angle - 180;
        aspectVal = (aspectVal + 180 + 360) % 360 - 180;
        document.getElementById("orientationIrr").value = aspectVal.toFixed(1);
        document.getElementById("orientation").value = aspectVal.toFixed(1);
        alert(`Orientation déterminée: ${aspectVal.toFixed(1)}° (0 = Sud)`);
        drawnItems.removeLayer(layer);
      }
    });

    /***************************************************
     * RECHERCHE D'ADRESSE, MARQUEUR ET TERRITOIRE
     ***************************************************/
    const addressSearchBtn = document.getElementById("addressSearchBtn");
    addressSearchBtn.addEventListener("click", searchAddress);

    function searchAddress() {
      const address = document.getElementById("address").value;
      if(!address) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(r => r.json())
        .then(data => {
          if(data.length > 0){
            const { lat, lon, display_name } = data[0];
            map.setView([lat, lon], 18);
            AdresseField.value = address;
            if(searchMarker){
              map.removeLayer(searchMarker);
            }
            searchMarker = L.marker([lat, lon]).addTo(map);
            searchMarker.bindPopup(`Adresse trouvée : ${address}`).openPopup();
            document.getElementById("latitudeIrr").value = lat;
            document.getElementById("longitudeIrr").value = lon;
            let foundCP = null;
            if(data[0].address && data[0].address.postcode){
              foundCP = data[0].address.postcode;
            } else {
              const patternCP = /\b(\d{4,5})\b/;
              let match = display_name.match(patternCP);
              if(match) foundCP = match[1];
            }
            if(foundCP){
              document.getElementById("territory").value = "France Metropolitaine";
            } else {
              document.getElementById("territory").value = "France Metropolitaine";
            }
          } else {
            alert("Adresse introuvable.");
          }
        })
        .catch(err => {
          console.error("Erreur recherche adresse:", err);
          alert("Une erreur est survenue lors de la recherche de l'adresse.");
        });
    }

    /***************************************************
     * CALCUL DU PRODUCTIBLE (API PVGIS)
     ***************************************************/
    async function getProductible(lat, lon, aspectValue) {
      const angleValue = parseFloat(document.getElementById("angleIrr").value) || 35;
      const originalUrl = `https://re.jrc.ec.europa.eu/api/v5_2/PVcalc?outputformat=basic&lat=${lat}&lon=${lon}&raddatabase=PVGIS-SARAH2&peakpower=1&loss=14&pvtechchoice=crystSi&angle=${angleValue}&aspect=${aspectValue}&usehorizon=1`;
      const proxyUrl = `https://corsproxy.io/?key=a32495b2&url=${encodeURIComponent(originalUrl)}`;
      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) return null;
        const text = await response.text();
        const lines = text.split("\n");
        let yearProduction = null;
        let tempMonthly = [];
        for (let line of lines) {
          let cleanLine = line.trim();
          if (!cleanLine) continue;
          if (cleanLine.includes("Year")) {
            const parts = cleanLine.split("\t").map(s => s.trim());
            yearProduction = parseFloat(parts[1]);
          }
          else if (/^\d+\s/.test(cleanLine)) {
            const parts = cleanLine.split("\t").map(s => s.trim());
            if (parts.length >= 3) {
              const monthNumber = parseInt(parts[0], 10);
              const E_mValue = parseFloat(parts[2]);
              tempMonthly.push({ month: monthNumber, E_m: E_mValue });
            }
          }
        }
        monthlyProductionData = tempMonthly;
        return { yearProduction, monthlyProduction: tempMonthly };
      } catch(e) {
        console.error(e);
        return null;
      }
    }

    const calculateIrrButton = document.getElementById("calculateIrrButton");
    calculateIrrButton.addEventListener("click", async () => {
      const lat = parseFloat(document.getElementById("latitudeIrr").value);
      const lon = parseFloat(document.getElementById("longitudeIrr").value);
      const aspectValue = parseFloat(document.getElementById("orientation").value);
      if (isNaN(lat) || isNaN(lon)) {
        alert("Veuillez d'abord renseigner la latitude et la longitude.");
        return;
      }
      const result = await getProductible(lat, lon, aspectValue);
      if (result && result.yearProduction !== null) {
        document.getElementById("productible").value = result.yearProduction.toLocaleString('fr-FR');
      } else {
        alert("Impossible de récupérer le productible. Vérifiez la connexion ou les données.");
      }
    });

    /***************************************************
     * CALCUL DU COÛT PAR kWh (TABLEAU CONSO - ONGLET 7)
     ***************************************************/
    function calculateCost(index) {
      const eurosInput = document.getElementById(`euros_${index}`);
      const kwhInput = document.getElementById(`kwh_${index}`);
      const costCell = document.getElementById(`costPerKwh_${index}`);
      if (!eurosInput || !kwhInput || !costCell) return;
      const euros = parseFloat(eurosInput.value) || 0;
      const kwh = parseFloat(kwhInput.value) || 0;
      if (kwh > 0) {
        const costPerKwh = (euros / kwh).toFixed(2);
        costCell.textContent = `${costPerKwh} €`;
      } else {
        costCell.textContent = "-";
      }
      calculateTotals();
    }

    function calculateTotals() {
      let totalEuros = 0, totalKwh = 0;
      for (let i = 0; i < 12; i++) {
        const eurosVal = document.getElementById(`euros_${i}`);
        const kwhVal = document.getElementById(`kwh_${i}`);
        if (!eurosVal || !kwhVal) continue;
        const eVal = parseFloat(eurosVal.value) || 0;
        const kVal = parseFloat(kwhVal.value) || 0;
        totalEuros += eVal;
        totalKwh += kVal;
      }
      const averageCostPerKwh = totalKwh > 0 ? (totalEuros / totalKwh).toFixed(2) : "-";
      document.getElementById("totalEuros").textContent = totalEuros.toFixed(2).toLocaleString('fr-FR') + " €";
      document.getElementById("totalKwh").textContent = totalKwh.toFixed(2).toLocaleString('fr-FR') + " kWh";
      document.getElementById("totalCostPerKwh").textContent = averageCostPerKwh !== "-" ? `${averageCostPerKwh} €` : "-";
    }

    /***************************************************
     * SAUVEGARDER / CHARGER JSON
     ***************************************************/
    const saveButton = document.getElementById("saveToFile");
    const loadFileInput = document.getElementById("loadFromFile");
    const uploadButton = document.getElementById("uploadFile");

    saveButton.addEventListener("click", () => {
      const form = document.getElementById("userForm");
      const rawFormData = new FormData(form);
      const formObject = {};
      rawFormData.forEach((value, key) => {
        // Pour les clés se terminant par "[]", on sauvegarde toujours sous forme de tableau
        if(key.endsWith("[]")) {
          if (!formObject[key]) {
            formObject[key] = [];
          }
          formObject[key].push(value);
        } else {
          if (formObject[key] !== undefined) {
            if (!Array.isArray(formObject[key])) {
              formObject[key] = [formObject[key]];
            }
            formObject[key].push(value);
          } else {
            formObject[key] = value;
          }
        }
      });
      const center = map.getCenter();
      formObject["mapCenterLat"] = center.lat;
      formObject["mapCenterLng"] = center.lng;
      formObject["mapZoom"] = map.getZoom();
      formObject["canvasImage"] = drawingCanvas.toDataURL();
      const shapesGeoJSON = drawnItems.toGeoJSON();
      formObject["drawnShapes"] = shapesGeoJSON;
      formObject["monthlyProductionData"] = monthlyProductionData;
      const companyName = formObject["companyName"] || "Formulaire";
      const fileName = `Formulaire_${companyName}.json`;
      const jsonString = JSON.stringify(formObject, null, 2);
      const blob = new Blob([jsonString], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    });

    uploadButton.addEventListener("click", () => {
      loadFileInput.click();
    });

    loadFileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const jsonData = JSON.parse(e.target.result);
          const form = document.getElementById("userForm");
          Object.keys(jsonData).forEach(key => {
            if (["mapCenterLat", "mapCenterLng", "mapZoom", "canvasImage", "drawnShapes", "monthlyProductionData"].includes(key)) {
              return;
            }
            const dataValue = jsonData[key];
            if (key.endsWith("[]")) {
              const checkboxes = form.querySelectorAll(`[name='${key}']`);
              checkboxes.forEach(checkbox => {
                if (Array.isArray(dataValue) && dataValue.includes(checkbox.value)) {
                  checkbox.checked = true;
                }
              });
            } else if (Array.isArray(dataValue)) {
              dataValue.forEach(val => {
                const checkbox = form.querySelector(`[name="${key}"][value="${val}"]`);
                if (checkbox) {
                  checkbox.checked = true;
                }
              });
            } else {
              const input = form.querySelector(`[name="${key}"]`);
              if (input) {
                input.value = dataValue;
              }
            }
          });
          if (jsonData["mapCenterLat"] !== undefined &&
              jsonData["mapCenterLng"] !== undefined &&
              jsonData["mapZoom"] !== undefined) {
            map.setView([jsonData["mapCenterLat"], jsonData["mapCenterLng"]], jsonData["mapZoom"]);
          }
          if (jsonData["canvasImage"]) {
            const image = new Image();
            image.onload = function() {
              ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
              ctx.drawImage(image, 0, 0);
            };
            image.src = jsonData["canvasImage"];
          }
          if (jsonData["drawnShapes"]) {
            drawnItems.clearLayers();
            L.geoJson(jsonData["drawnShapes"]).eachLayer(layer => {
              drawnItems.addLayer(layer);
            });
          }
        };
        reader.readAsText(file);
      }
    });

    /***************************************************
     * INITIALISATION DE FLATPICKR
     ***************************************************/
    flatpickr("#rdvDate", {
      locale: "fr",
      dateFormat: "d/m/Y"
    });

    /***************************************************
     * NOUVEAU CODE : CONVERSION DES CLÉS, TELECHARGEMENT ET ENVOI POST
     ***************************************************/

    // ----- TABLE DE CONVERSION DES CLÉS -----
    // Complétez cette table avec toutes les correspondances de votre fichier Excel.
    const conversionTable = {
      "companyName": "[:TCRPCMPNAME]",
"telephone": "[:TCRPIPHONE]",
"Adresse": "[:TCRPADDRESS]",
"email": "[:TCRPMAIL]",
"activity": "[:TCRPACTIVITY]",
"latitudeIrr": "[:Tf67940]",
"longitudeIrr": "[:Tf67941]",
"orientation": "[:Tf67942]",
"angleIrr": "[:Tf68528]",
"productible": "[:Tf67943]",
"Surface toiture": "[:Tf68562]",
"Type de toiture": "[:Tf68565]",
"Pente toiture": "[:Tf68528]",
"Type de couverture": "[:Tf68566]",
"Type de charpente": "[:Tf68570]",
"Translucides": "[:Tf68571]",
"Couvrir Translucides": "[:Tf68573]",
"Nom": "[:Tf68526]",
"Prénom": "[:Tf68527]",
"Statut": "[:Tf68586]",
"Propietaire/Locataire": "[:Tf68583]",
"Annees presence": "[:Tf68585]",

      // Ajoutez d'autres mappings selon votre table de conversion...
    };

    // ----- FONCTION POUR EXTRAIRE LES DONNÉES DU FORMULAIRE -----
    function getFormDataObject() {
      const form = document.getElementById("userForm");
      const rawFormData = new FormData(form);
      const formObject = {};
      
      rawFormData.forEach((value, key) => {
        if(key.endsWith("[]")) {
          if (!formObject[key]) {
            formObject[key] = [];
          }
          formObject[key].push(value);
        } else {
          if (formObject[key] !== undefined) {
            if (!Array.isArray(formObject[key])) {
              formObject[key] = [formObject[key]];
            }
            formObject[key].push(value);
          } else {
            formObject[key] = value;
          }
        }
      });
      
      // Ajout de quelques informations complémentaires
      const center = map.getCenter();
      formObject["mapCenterLat"] = center.lat;
      formObject["mapCenterLng"] = center.lng;
      formObject["mapZoom"] = map.getZoom();
      formObject["canvasImage"] = drawingCanvas.toDataURL();
      formObject["drawnShapes"] = drawnItems.toGeoJSON();
      formObject["monthlyProductionData"] = monthlyProductionData;
      
      return formObject;
    }

    // ----- FONCTION DE CONVERSION DES CLÉS -----
    function convertKeys(data) {
      const convertedData = {};
      for (const key in data) {
        if (conversionTable.hasOwnProperty(key)) {
          convertedData[conversionTable[key]] = data[key];
        }
        // Si le tag n'existe pas dans la table, on ignore la clé.
      }
      return convertedData;
    }

    // ----- ÉVÉNEMENT DU BOUTON POST -----
    document.getElementById("postData").addEventListener("click", function() {
      // Récupérer les données du formulaire
      const formData = getFormDataObject();
      
      // Convertir les clés avec la table de conversion
      const convertedData = convertKeys(formData);
      
      // Convertir en chaîne JSON
      const jsonString = JSON.stringify(convertedData, null, 2);
      
      // Téléchargement du JSON modifié sur le poste pour vérification
      const blob = new Blob([jsonString], { type: "application/json" });
      const downloadLink = document.createElement("a");
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = "donnees_modifiees.json";
      downloadLink.click();

      // Envoi des données via une requête POST
      fetch("https://application.betool.fr/crm/api/V1?token=VylYMVAhPXo1ZWdPPVVeLVRjOVBGamNWISppeXhrVkpMVmxabVdpTHVqQ3JkcGshcTU4NTg=&id=1660", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: jsonString
      })
      .then(response => response.json())
      .then(data => {
        console.log("Réponse du serveur:", data);
        alert("Les données ont été postées avec succès !");
      })
      .catch(error => {
        console.error("Erreur lors du POST:", error);
        alert("Erreur lors de la publication des données.");
      });
    });
  </script>
</body>
</html>
